# Test Infrastructure

This directory contains the test infrastructure for the Scheme interpreter.

## Usage

Run the test runner binary:

```bash
# Run all tests with all modes
cargo run --bin test_runner

# Run specific test with all modes  
cargo run --bin test_runner simple

# Run specific test with specific mode
cargo run --bin test_runner simple result
cargo run --bin test_runner arithmetic bytecode
```

## Test Modes

The test infrastructure supports three test modes:

### 1. Result Mode (`result`)
Compares the final evaluation result of the test file against `tests/foo.result`.

**Example:**
- Test file: `tests/simple.scm` contains `(+ 1 2)`
- Reference: `tests/simple.result` contains `3`

### 2. Output Mode (`output`) 
Compares the display output (future: stdout captures) against `tests/foo.out`.

**Example:**
- Test file: `tests/display.scm` contains `(display "hello")`
- Reference: `tests/display.out` contains `hello`

### 3. Bytecode Mode (`bytecode`)
Compares the generated bytecode assembly against `tests/foo.asm`.

**Example:**
- Test file: `tests/simple.scm` contains `(+ 1 2)`
- Reference: `tests/simple.asm` contains:
  ```
  0000: LOAD_CONST 0 ; 1
  0001: LOAD_CONST 1 ; 2  
  0002: LOAD_VAR 0 ; +
  0003: TAIL_CALL 2
  0004: RETURN
  ```

## Reference File Management

### Updating Reference Files
Set the `UPDATE_TEST_REFERENCES` environment variable to update reference files when tests fail:

```bash
# PowerShell
$env:UPDATE_TEST_REFERENCES="1"; cargo run --bin test_runner

# Command Prompt  
set UPDATE_TEST_REFERENCES=1 && cargo run --bin test_runner

# Bash/Linux
UPDATE_TEST_REFERENCES=1 cargo run --bin test_runner
```

This will automatically update `.out`, `.asm`, and `.result` files with the actual test output.

### Reference File Locations
- `tests/foo.scm` - Test source code
- `tests/foo.result` - Expected final result
- `tests/foo.out` - Expected display output  
- `tests/foo.asm` - Expected bytecode assembly

## Test Organization

Tests are organized as:
- **Simple tests**: Basic arithmetic, literals  
- **Arithmetic tests**: Multiple operations
- **Lambda tests**: Function definition and application
- **Display tests**: Output testing (future enhancement)

## Implementation Notes

- Tests run in **non-CPS mode** by default to avoid continuation requirements
- The test runner uses the public `compiler::compile()` API
- Bytecode is formatted as human-readable assembly for easier debugging
- The test runner creates fresh VM instances for each test mode
- Reference files are automatically created/updated when missing or when `UPDATE_TEST_REFERENCES` is set

## Future Enhancements

- **Display capture**: Currently captures final results, could capture actual `display` builtin calls
- **Error testing**: Test expected compilation/runtime errors
- **Performance testing**: Benchmark test execution times  
- **CPS testing**: Add CPS-mode specific tests
- **Macro testing**: Test macro expansion results